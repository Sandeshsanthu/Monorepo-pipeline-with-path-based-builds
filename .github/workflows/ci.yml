name: Monorepo CI (path-based)

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      app_a: ${{ steps.filter.outputs.app_a }}
      app_b: ${{ steps.filter.outputs.app_b }}
      shared: ${{ steps.filter.outputs.shared }}
      global: ${{ steps.filter.outputs.global }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app_a:
              - 'apps/app-a/**'
            app_b:
              - 'apps/app-b/**'
            shared:
              - 'libs/shared/**'
            global:
              - 'package.json'
              - 'package-lock.json'
              - 'pnpm-lock.yaml'
              - 'yarn.lock'
              - '.github/workflows/**'

  build_app_a:
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.app_a == 'true' || needs.detect_changes.outputs.shared == 'true' || needs.detect_changes.outputs.global == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build/Test app-a (demo)
        run: |
          echo "Building app-a because app-a/shared/global changed"
          ls -la apps/app-a

  build_app_b:
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.app_b == 'true' || needs.detect_changes.outputs.shared == 'true' || needs.detect_changes.outputs.global == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build/Test app-b (demo)
        run: |
          echo "Building app-b because app-b/shared/global changed"
          ls -la apps/app-b
